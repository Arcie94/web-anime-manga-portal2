---
import Layout from "../../../layouts/Layout.astro";
import { apiFetch } from "../../../lib/api";
import MangaReader from "../../../components/MangaReader";

export const prerender = false;

const { slug } = Astro.params;

let images: string[] = [];
let title = "";
let nextSlug = "";
let error = "";

if (slug) {
  try {
    const res = await apiFetch<any>(`/manga/chapter/${slug}`);
    images = res.images || [];
    nextSlug = res.nextSlug || ""; // Get Next Slug from API

    // Use API title or format slug as fallback
    if (res.title) {
      title = res.title;
    } else if (slug) {
      // Fallback: one-piece-chapter-1170 -> One Piece Chapter 1170
      title = slug
        .split("-")
        .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
        .join(" ");
    }
  } catch (e) {
    error = "Gagal memuat gambar chapter.";
  }
}
---

<Layout
  title="Baca Manga - AnimePlay"
  allowZoom={true}
  hideHeader={true}
  hideBottomNav={true}
>
  <!-- Immersive Header (Auto-hide) -->
  <div
    id="reader-header"
    class="fixed top-0 left-0 right-0 z-50 flex items-center justify-between bg-black/90 backdrop-blur-md px-4 py-3 border-b border-white/10 transition-transform duration-300"
  >
    <button
      onclick="history.length > 1 ? history.back() : window.location.href = '/manga'"
      class="w-10 h-10 flex items-center justify-center rounded-full bg-white/5 hover:bg-white/20 text-white transition-all active:scale-95"
      aria-label="Kembali"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="2.5"
        stroke="currentColor"
        class="w-5 h-5"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18"></path>
      </svg>
    </button>

    <h1
      id="chapter-header-title"
      class="text-base md:text-lg font-bold text-gray-100 truncate max-w-[60vw] text-center"
    >
      {title || "Chapter Reader"}
    </h1>

    <div class="w-10"></div>
    <!-- Spacer for alignment -->
  </div>

  <script>
    // Smart Auto-Hide Logic
    let lastScrollY = window.scrollY;
    const header = document.getElementById("reader-header");

    window.addEventListener(
      "scroll",
      () => {
        const currentScrollY = window.scrollY;

        if (currentScrollY > lastScrollY && currentScrollY > 100) {
          // Scrolling Down -> Hide
          header?.classList.add("-translate-y-full");
        } else {
          // Scrolling Up -> Show
          header?.classList.remove("-translate-y-full");
        }

        lastScrollY = currentScrollY;
      },
      { passive: true }
    );
  </script>

  <div class="max-w-4xl mx-auto pt-16">
    <!-- Added pt-16 to compensate for fixed header -->

    {
      error && (
        <div class="bg-red-500/20 text-red-200 p-4 rounded-lg text-center">
          {error}
        </div>
      )
    }

    <div class="min-h-screen">
      <MangaReader
        client:load
        initialSlug={slug || ""}
        initialTitle={title}
        initialImages={images}
        initialNextSlug={nextSlug}
      />
    </div>

    <div class="text-center py-10">
      <p class="text-gray-500">Akhir dari chapter ini.</p>
      <a
        href="javascript:history.back()"
        class="inline-block mt-4 bg-gray-800 hover:bg-gray-700 text-white px-6 py-2 rounded-full transition-colors"
      >
        Kembali ke Detail
      </a>
    </div>
  </div>
</Layout>
