---
import Layout from "../../../layouts/Layout.astro";
import { apiFetch } from "../../../lib/api";
import MangaReader from "../../../components/MangaReader";

export const prerender = false;

const { slug } = Astro.params;

let images: string[] = [];
let title = "";
let nextSlug = "";
let error = "";

if (slug) {
  try {
    const res = await apiFetch<any>(`/manga/chapter/${slug}`);
    images = res.images || [];
    nextSlug = res.nextSlug || ""; // Get Next Slug from API

    // Use API title or format slug as fallback
    if (res.title) {
      title = res.title;
    } else if (slug) {
      // Fallback: one-piece-chapter-1170 -> One Piece Chapter 1170
      title = slug
        .split("-")
        .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
        .join(" ");
    }
  } catch (e) {
    error = "Gagal memuat gambar chapter.";
  }
}
---

<Layout title="Baca Manga - AnimePlay" allowZoom={true}>
  <div class="max-w-4xl mx-auto">
    <div
      class="flex items-center justify-between mb-6 sticky top-20 z-40 bg-gray-900/90 backdrop-blur p-4 rounded-xl border border-gray-800"
    >
      <button
        onclick="history.length > 1 ? history.back() : window.location.href = '/manga'"
        class="w-10 h-10 flex items-center justify-center rounded-full bg-white/5 hover:bg-white/20 text-white border border-white/10 transition-all hover:scale-110 active:scale-95 backdrop-blur-sm"
        aria-label="Kembali"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="2.5"
          stroke="currentColor"
          class="w-5 h-5"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18"></path>
        </svg>
      </button>
      <h1 id="chapter-header-title" class="text-lg font-bold text-gray-200">
        {title || "Chapter Reader"}
      </h1>
      <div></div>
      {/* Spacer */}
    </div>

    {
      error && (
        <div class="bg-red-500/20 text-red-200 p-4 rounded-lg text-center">
          {error}
        </div>
      )
    }

    <div class="min-h-screen">
      <MangaReader
        client:load
        initialSlug={slug || ""}
        initialTitle={title}
        initialImages={images}
        initialNextSlug={nextSlug}
      />
    </div>

    <div class="text-center py-10">
      <p class="text-gray-500">Akhir dari chapter ini.</p>
      <a
        href="javascript:history.back()"
        class="inline-block mt-4 bg-gray-800 hover:bg-gray-700 text-white px-6 py-2 rounded-full transition-colors"
      >
        Kembali ke Detail
      </a>
    </div>
  </div>
</Layout>
