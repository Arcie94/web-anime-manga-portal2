---
import Layout from "../layouts/Layout.astro";
import HeroCarousel from "../components/HeroCarousel";
import ContentRow from "../components/ContentRow";
import CategoryRow from "../components/CategoryRow";
import { apiFetch } from "../lib/api";
import { FEATURED_MANGA } from "../data/featuredManga";

export const prerender = false;

// Fetch homepage data from Sankavollerei Comic API (SSR)
let trendingManga: any[] = [];
let ongoingManga: any[] = [];
let actionManga: any[] = [];
let romanceManga: any[] = [];
let dramaManga: any[] = [];
let fantasyManga: any[] = [];

try {
  // Parallel fetch for all sections
  const [
    trendingData,
    ongoingData,
    actionData,
    romanceData,
    dramaData,
    fantasyData,
  ] = await Promise.all([
    apiFetch<{ data: { mangaList: any[] } }>("/manga/trending"),
    apiFetch<{ data: { mangaList: any[] } }>("/manga/ongoing"),
    apiFetch<{ data: { mangaList: any[] } }>("/manga/genres/Action"),
    apiFetch<{ data: { mangaList: any[] } }>("/manga/genres/Romance"),
    apiFetch<{ data: { mangaList: any[] } }>("/manga/genres/Drama"),
    apiFetch<{ data: { mangaList: any[] } }>("/manga/genres/Fantasy"),
  ]);

  trendingManga = trendingData?.data?.mangaList || [];
  ongoingManga = ongoingData?.data?.mangaList || [];
  actionManga = actionData?.data?.mangaList || [];
  romanceManga = romanceData?.data?.mangaList || [];
  dramaManga = dramaData?.data?.mangaList || [];
  fantasyManga = fantasyData?.data?.mangaList || [];
} catch (error) {
  console.error("Failed to fetch manga home data:", error);
}

// Deduplication Logic
const seenIds = new Set<string>();

const filterDuplicates = (items: any[]) => {
  return items.filter((item) => {
    // Identify by slug or title if slug is missing, but slug is preferred
    const id = item.slug || item.title;
    if (!id) return true; // Keep items without ID just in case

    if (seenIds.has(id)) {
      return false;
    }
    seenIds.add(id);
    return true;
  });
};

// Apply filter sequentially (Priority ORDER matters!)
trendingManga = filterDuplicates(trendingManga);

// Latest/Ongoing: Show ALL (even if in Trending), but mark them so they don't appear in Genres
const markAsSeen = (items: any[]) => {
  items.forEach((item) => {
    const id = item.slug || item.title;
    if (id) seenIds.add(id);
  });
  return items;
};
ongoingManga = markAsSeen(ongoingManga);

// Genres comes after trending/ongoing
actionManga = filterDuplicates(actionManga);
romanceManga = filterDuplicates(romanceManga);
dramaManga = filterDuplicates(dramaManga);
fantasyManga = filterDuplicates(fantasyManga);
---

<Layout title="AnimePlay - Read Manga Online">
  {/* Hero Carousel */}
  <div class="relative z-0">
    <HeroCarousel featured={FEATURED_MANGA} client:only="react" />
  </div>

  {/* Sub-Header Categories */}
  <CategoryRow client:visible />

  {/* Content Rows (Hydrated for interactivity) */}
  <ContentRow
    title="Trending Manga"
    items={trendingManga}
    type="manga"
    client:load
  />

  <ContentRow
    title="Latest Updates"
    items={ongoingManga}
    type="manga"
    client:load
  />

  {/* Genre Sections */}
  <ContentRow
    title="Action Manga"
    items={actionManga}
    type="manga"
    client:visible
  />
  <ContentRow
    title="Romance Manga"
    items={romanceManga}
    type="manga"
    client:visible
  />
  <ContentRow
    title="Drama Manga"
    items={dramaManga}
    type="manga"
    client:visible
  />
  <ContentRow
    title="Fantasy Manga"
    items={fantasyManga}
    type="manga"
    client:visible
  />
</Layout>
